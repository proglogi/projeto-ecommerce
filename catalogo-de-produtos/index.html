<!--Página principal (catálogo de produtos)-->

<!DOCTYPE html>
<html lang="pt-BR">

<head>
	<title>Home</title>

	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="description" content="">
	<meta name="keywords" content="">
	<meta name="author" content="Nicholly Gonzaga">

	<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
	<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>

	<!-- Importando a fonte "Orbitron" do Google Fonts -->
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400..900&display=swap" rel="stylesheet">

	<link rel="stylesheet" href="CSS/style.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<body>
	<!-- Cabeçalho -->
	<header>
		<img src="https://res.cloudinary.com/dsf2txoqr/image/upload/v1747959665/svim96ficucptxatnuum.png" width="150px" alt="Logo Zumbits">
		<h1><b> Zumbits </b></h1><br>
	</header>

	<!-- Menu -->
	<div class="navbar">
		<a href="#home">Home</a>
		<div class="dropdown">
			<button class="dropbtn">
				Produtos
				<i class="fa fa-caret-down"></i>
			</button>
			<div class="dropdown-content">
				<a href="#">Colecionáveis</a>
				<a href="#">Eletrônicos</a>
				<a href="#">HQs</a>
				<a href="#">Jogos</a>
				<a href="#">Pôsters</a>
			</div>
		</div>
		<a href="#">Sobre</a>
		<a href="#">Contato</a>
	</div>

	<!-- Conteúdo do Catálogo -->
	<section id="catalogSection">
		<div id="productList" class="catalog"></div>
		<br>
	</section>

	<!-- Detalhamento do Produto (inicialmente oculto) -->
	<section id="productDetailSection" style="display: none;">
		<button class="back-button" onclick="goBack()">&#8592; Voltar</button>
		<div class="product-detail" id="productDetail">
			<p>Carregando detalhes...</p>
		</div>
	</section>

	<!-- Pop-up de Confirmação de Compra -->
	<div id="popup" class="popup" style="display: none;">
		<div class="popup-conteudo">
			<span class="fechar" id="fechar">&times;</span>
			<h2>Confirmação de Compra</h2>
			<p id="popupTexto">Você deseja realmente comprar este item?</p>
			<label for="quantidadeCompra">Quantidade:</label>
			<input type="number" id="quantidadeCompra" name="quantidadeCompra" min="1" value="1" />
			<br><br>
			<button onclick="confirmarPopup()">Confirmar</button>
		</div>
	</div>


	<!-- Rodapé -->
	<footer>
		<p>2025 | Feito por Nicholly Gonzaga dos Santos</p>
	</footer>

	<script>
		document.addEventListener("DOMContentLoaded", function () {
			console.log("Página carregada, iniciando Firebase...");

			// Configuração do Firebase
			const firebaseConfig = {
				apiKey: "AIzaSyCjjy2B9jb2XZW4nIfMj1xDLogZc8oBd9M",
				authDomain: "estoque-naturale.firebaseapp.com",
				databaseURL: "https://estoque-naturale-default-rtdb.firebaseio.com",
				projectId: "estoque-naturale",
				storageBucket: "estoque-naturale.firebasestorage.app",
				messagingSenderId: "204707025194",
				appId: "1:204707025194:web:158dd6235e0996b6e54e53",
				measurementId: "G-ZJMVMSTSBJ"
			};

			// Inicializa o Firebase
			firebase.initializeApp(firebaseConfig);

			// Referência ao nó 'produtos'
			const db = firebase.database().ref("produtos");

			// Executa mudanças em 'produtos'
			db.on("value", (snapshot) => {
				console.log("Firebase snapshot bruto:", snapshot.val());

				const list = document.getElementById("productList");
				list.innerHTML = ""; // limpa os cards antes de renderizar novamente

				const dados = snapshot.val();
				console.log("Dados recebidos do Firebase:", dados);

				if (!dados) {
					list.innerHTML = "<p>Nenhum produto cadastrado.</p>";
					return;
				}

				Object.entries(dados).forEach(([id, produto]) => {
					const {
						descricao,
						precoVenda,
						precoCusto,
						categoria,
						marca,
						estoque,
						status,
						caracteristicas,
						fornecedor,
						dataCompra
					} = produto;

					const card = document.createElement("div");
					card.classList.add("product-card");

					card.innerHTML = `
						<a href="javascript:void(0);" onclick="loadProductDetail('${id}')">
							<img src="${produto.imagem}" alt="${descricao}" class="product-image">
							<h4>${descricao}</h4>
							<p>R$ ${precoVenda?.toFixed(2) ?? "0.00"}</p>
							<p>Marca: ${marca}</p>
							<p>Estoque: ${estoque ?? "-"}</p>
							<p>Status: ${status}</p>
						</a>
						<button class="botao-comprar" onclick="abrirPopup('${id}', '${descricao}', '${precoVenda?.toFixed(2)}', ${estoque ?? 0})">Comprar</button>
					`;

					list.appendChild(card);
					console.log("Imagem URL do produto:", produto.imagem);
				});
			});
		});

		// Função para carregar os detalhes do produto
		function loadProductDetail(productId) {
			const catalogSection = document.getElementById("catalogSection");
			const productDetailSection = document.getElementById("productDetailSection");
			const productDetailDiv = document.getElementById("productDetail");

			catalogSection.style.display = "none";
			productDetailSection.style.display = "block";

			// Busca os dados do produto no Firebase
			firebase.database().ref(`produtos/${productId}`).get().then(snapshot => {
				const produto = snapshot.val();

				if (!produto) {
					productDetailDiv.innerHTML = "<p>Produto não encontrado.</p>";
					return;
				}

				const {
					descricao,
					precoVenda,
					marca,
					estoque,
					status,
					caracteristicas,
					imagem
				} = produto;

				productDetailDiv.innerHTML = `
					<div class="product-detail-container">
						<h2 class="product-title">${descricao}</h2>
						<div class="detail-content">
							<img src="${imagem}" alt="${descricao}" class="product-detail-image">
							<div class="product-info">
								<div class="info-item"><i class="fas fa-tag"></i> <strong>Marca:</strong> ${marca}</div>
								<div class="info-item"><i class="fas fa-dollar-sign"></i> <strong>Preço de Venda:</strong> R$ ${precoVenda?.toFixed(2) ?? "0.00"}</div>
								<div class="info-item"><i class="fas fa-cogs"></i> <strong>Estoque:</strong> ${estoque ?? "-"}</div>
								<div class="info-item">
									<i class="fas fa-check-circle"></i> <strong>Status:</strong> 
									<span class="status ${status === 'em estoque' ? 'in-stock' : 'out-of-stock'}">${status}</span>
								</div>
								<div class="info-item"><i class="fas fa-info-circle"></i> <strong>Características:</strong> ${caracteristicas}</div>
							</div>
						</div>
					</div>
				`;

			});
		}

		function goBack() {
			document.getElementById("productDetailSection").style.display = "none";
			document.getElementById("catalogSection").style.display = "block";
		}

		// Pop-up de Compra
		function abrirPopup(productId, descricao, preco, estoque) {
		const popup = document.getElementById("popup");
		const texto = document.getElementById("popupTexto");
		const inputQtd = document.getElementById("quantidadeCompra");

		texto.innerText = `Você deseja comprar "${descricao}" por R$ ${preco}?`;
		inputQtd.max = estoque;
		inputQtd.value = 1;
		inputQtd.min = 1;

		popup.dataset.productId = productId;
		popup.dataset.estoque = estoque;

		if (estoque === 0) {
			inputQtd.disabled = true;
			texto.innerText = `Produto "${descricao}" está esgotado.`;
		} else {
			inputQtd.disabled = false;
		}

		popup.style.display = "block";
		}

		// Guardar valores para confirmar compra
		popup.dataset.descricao = descricao;
		popup.dataset.preco = preco;
		popup.dataset.estoque = estoque;

		function confirmarPopup() {
		const popup = document.getElementById("popup");
		const productId = popup.dataset.productId;
		const estoque = parseInt(popup.dataset.estoque, 10);
		const qtd = parseInt(document.getElementById("quantidadeCompra").value, 10);

		if (qtd > estoque) {
			alert(`Quantidade excede o estoque disponível (${estoque}).`);
			return;
		}

		const produtoRef = firebase.database().ref(`produtos/${productId}`);

		produtoRef.transaction((produtoAtual) => {
			if (produtoAtual && produtoAtual.estoque >= qtd) {
			produtoAtual.estoque -= qtd;
			return produtoAtual;
			} else {
			alert('Estoque insuficiente ou produto não encontrado.');
			return;
			}
		}).then(result => {
			if (result.committed) {
			alert(`Compra confirmada! Você comprou ${qtd} unidade(s).`);

			// Fecha o pop-up
			popup.style.display = "none";

			// Volta para o catálogo (caso esteja em outra seção)
			document.getElementById("productDetailSection").style.display = "none";
			document.getElementById("purchaseSection").style.display = "none";
			document.getElementById("catalogSection").style.display = "block";

			// O listener do Firebase (db.on("value")) já vai atualizar o catálogo automaticamente!

			} else {
			alert('A compra foi cancelada.');
			}
		}).catch(err => {
			console.error('Erro ao atualizar estoque:', err);
			alert('Erro ao processar a compra.');
		});
		}
	</script>
</body>

</html>